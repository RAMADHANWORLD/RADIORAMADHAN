<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadhan World App - Prayer Times, Qibla, Quran</title>
    <meta name="description" content="An all-in-one Islamic app featuring accurate prayer times, Sehri and Iftar times, Qibla compass, Quran recitation, a dynamic Islamic calendar, Naat collection, Tasbeeh counter, and live radio. Your perfect companion for Ramadan and daily worship.">
    <meta name="keywords" content="islamic app, prayer times, qibla direction, quran online, ramadan 2025, sehri time, iftar time, islamic calendar, hijri date, naat, tasbeeh counter, ramadhan world, islamic history, salah times, listen quran">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .font-amiri {
            font-family: 'Amiri', serif;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .prayer-time.active {
            background-color: rgba(57, 255, 20, 0.3); /* Neon Green shade */
            border-left-width: 4px;
            border-color: #39FF14; /* Neon Green */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .nav-button.active {
            background-color: #39FF14; /* Neon Green */
            color: #1f2937; /* Dark text for readability */
            font-weight: bold;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.5);
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem;
            max-width: 960px;
            margin: auto;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Qibla Compass Specific Styles */
        #compass {
            position: relative;
            width: 256px;
            height: 256px;
            background-color: #1f2937;
            border-radius: 9999px;
            border: 4px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem auto;
        }
        .direction {
            position: absolute;
            font-weight: bold;
            color: #9ca3af;
        }
        .direction.north { top: 10px; font-size: 1.5rem; color: #ef4444; }
        .direction.south { bottom: 10px; }
        .direction.east { right: 10px; }
        .direction.west { left: 10px; }
        #qibla-line {
            position: absolute;
            width: 3px;
            height: 128px;
            background-color: #39FF14; /* Neon Green */
            top: 0;
            left: 50%;
            transform-origin: bottom center;
            transition: transform 0.2s linear;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.7); /* Neon Green Glow */
            z-index: 5;
        }
        /* New Sections Styling */
        .section-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 48rem;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .section-title {
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.875rem;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #39FF14; /* Neon Green */
        }
        #islamic-history-content p {
            font-size: 1.125rem;
            line-height: 1.75;
            color: #d1d5db;
        }
        .action-btn {
            background-color: #39FF14; /* Neon Green */
            color: #1f2937; /* Dark text for readability */
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
        }
        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #39FF14; /* Neon Green Glow on Hover */
        }
        .action-btn-small {
            background-color: #374151;
            color: white;
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
        }
        .calendar-item {
            background-color: rgba(57, 255, 20, 0.1); /* Neon Green shade */
            border: 1px solid rgba(57, 255, 20, 0.3); /* Neon Green shade */
            border-radius: 0.75rem;
            padding: 1.25rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        .calendar-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
        }
        .calendar-date {
            font-family: 'Amiri', serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937; /* Dark text for readability */
            background-color: #39FF14; /* Neon Green */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            display: inline-block;
            margin-bottom: 0.75rem;
        }
        .calendar-event-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: #adff2f; /* Lighter Neon Green shade */
            margin-bottom: 0.5rem;
        }
        .calendar-event-desc {
            font-size: 1rem;
            color: #d1d5db;
            flex-grow: 1; /* Pushes date to bottom */
        }
        .gregorian-date {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 0.75rem;
        }
        /* Inbox Styling */
        #inbox-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        .inbox-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #39FF14; /* Neon Green */
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        .inbox-item.history {
            border-left-color: #f59e0b; /* Amber */
        }
        .inbox-item .timestamp {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .text-neon { color: #39FF14; }
        .border-neon { border-color: #39FF14; }
        .bg-neon { background-color: #39FF14; color: #1f2937; font-weight: bold; }
        .hover-bg-neon:hover { background-color: #39FF14; color: #1f2937; font-weight: bold; box-shadow: 0 0 15px rgba(57, 255, 20, 0.5); }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50 transition-opacity duration-500">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-neon"></div>
        <p class="mt-4 text-lg">Finding your location & fetching data...</p>
        <p id="location-prompt" class="mt-2 text-yellow-400 hidden">Please enable location services and refresh.</p>
    </div>

    <div id="main-content" class="min-h-screen container mx-auto p-4 sm:p-6 lg:p-8 opacity-0 transition-opacity duration-1000">
        <!-- Header Section -->
        <header class="text-center mb-6">
            <img id="app-logo" src="https://i.ibb.co/Zp0bgjsS/ART-WORKS-1.png" alt="Ramadhan World Logo" class="w-[200px] h-[200px] mx-auto mb-4 rounded-full shadow-lg object-contain">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-neon">Ramadhan World</h1>
            <p id="islamic-date" class="text-lg text-gray-300 mt-2">Loading Islamic Date...</p>
            <p id="location" class="text-md text-gray-400 mt-1">Fetching location...</p>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center gap-2 mb-6 flex-wrap items-center">
            <button onclick="showView('home')" class="nav-button active px-4 py-2 rounded-lg bg-gray-700 transition">Home</button>
            <button onclick="showView('salah')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Salah</button>
            <button onclick="showView('listenQuran')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Quran</button>
            <button onclick="showView('tasbeeh')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Tasbeeh</button>
            <button onclick="showView('naat')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Naat</button>
            <button onclick="showView('qibla')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Qibla</button>
            <button onclick="showView('calendar')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Calendar</button>
            <button onclick="showView('inbox')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Inbox</button>
            <button onclick="showView('settings')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Settings</button>
        </nav>

        <!-- Main Views -->
        <main>
            <!-- Home View -->
            <div id="home-view">
                <section id="countdown-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <h2 class="text-2xl font-semibold mb-2">Time until <span id="next-prayer-name" class="text-neon">...</span></h2>
                        <div id="countdown-timer" class="text-5xl font-extrabold text-neon tracking-wider">00:00:00</div>
                    </div>
                </section>
                <section id="home-radio-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <button onclick="playRamadhanWorldRadio()" class="bg-neon text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg transition transform hover:scale-105">
                            Play Ramadhan World Radio
                        </button>
                        <div id="home-radio-player" class="mt-6 text-center">
                            <div id="home-radio-loading-indicator" class="hidden">
                                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-neon mx-auto"></div>
                                <p class="text-sm mt-2">Loading stream...</p>
                            </div>
                            <audio id="home-radio-audio-player" controls class="w-full rounded-lg hidden" crossorigin="anonymous"></audio>
                        </div>
                    </div>
                </section>

                <!-- Today in Islamic History Section -->
                <section id="islamic-history-section" class="mb-8">
                    <div class="section-card">
                        <h2 class="section-title">🕋 Today in Islamic History</h2>
                        <div id="islamic-history-content" class="text-center">
                            <p>Loading historical context...</p>
                        </div>
                    </div>
                </section>
            </div>
            
             <!-- Inbox View -->
            <div id="inbox-view" class="hidden">
                <div class="section-card">
                    <h2 class="section-title">📥 Inbox</h2>
                    <div id="inbox-list">
                        <p class="text-center text-gray-400">No notifications yet.</p>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendar-view" class="hidden">
                <section id="islamic-calendar-section">
                     <div class="section-card">
                        <h2 class="section-title">🗓️ Major Islamic Events</h2>
                        <div id="calendar-loading-indicator" class="text-center py-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-neon mx-auto"></div>
                            <p class="mt-4 text-lg">Fetching live dates...</p>
                        </div>
                        <div id="islamic-calendar-grid" class="calendar-grid">
                            <!-- Events will be populated here by JavaScript -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Qibla View -->
            <div id="qibla-view" class="hidden text-center">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Qibla Compass</h2>
                    <div id="compass">
                        <div class="direction north">N</div>
                        <div class="direction south">S</div>
                        <div class="direction east">E</div>
                        <div class="direction west">W</div>
                        <div id="qibla-line"></div>
                    </div>
                    <p id="qibla-direction" class="mt-4 text-lg text-gray-300">For accurate results, hold your device flat, away from any metals.</p>
                    <p class="text-lg text-yellow-400 mt-4 font-bold">THIS FEATURE IS COMING SOON</p>
                    <p class="text-sm text-gray-400 mt-2">(Accuracy depends on your device's hardware and browser support)</p>
                </div>
            </div>

            <!-- Listen Quran View -->
            <div id="listen-quran-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Holy Quran Recitation</h2>
                    <div id="quran-loading-indicator" class="text-center py-8 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-neon mx-auto"></div>
                        <p class="mt-4 text-lg">Loading Surahs...</p>
                    </div>
                    <div id="quran-surah-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    <div id="quran-player" class="mt-6 text-center hidden">
                        <h3 id="current-surah-name" class="text-xl font-bold mb-2 text-neon"></h3>
                        <audio id="quran-audio-player" controls class="w-full rounded-lg"></audio>
                    </div>
                </div>
            </div>

            <!-- Salah View -->
            <div id="salah-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Today's Times</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div id="salah-fajr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Fajr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-sunrise" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Sunrise</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-dhuhr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Dhuhr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-asr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Asr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-maghrib" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Maghrib</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-isha" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Isha</span><span class="text-xl font-mono">--:--</span></div>
                    </div>
                    <hr class="border-gray-600 my-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div id="salah-sehri" class="card rounded-xl p-4 flex justify-between items-center border-l-4" style="background-color: rgba(57, 255, 20, 0.2); border-color: #39FF14;">
                            <span class="font-semibold text-lg">Sehri End</span>
                            <span class="text-xl font-mono">--:--</span>
                        </div>
                        <div id="salah-iftar" class="card rounded-xl p-4 flex justify-between items-center bg-yellow-800 border-l-4 border-yellow-400">
                            <span class="font-semibold text-lg">Iftar</span>
                            <span class="text-xl font-mono">--:--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tasbeeh View -->
            <div id="tasbeeh-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto text-center">
                    <h2 class="text-2xl font-semibold mb-4">Tasbeeh Counter</h2>
                    <div id="tasbeeh-counter-display" class="font-mono text-7xl font-bold text-neon mb-4">0</div>
                    <button onclick="incrementTasbeeh()" class="w-48 h-48 rounded-full bg-neon text-gray-900 text-5xl flex items-center justify-center mx-auto shadow-lg transform transition hover:scale-105 active:scale-95" style="box-shadow: 0 0 20px rgba(57, 255, 20, 0.6);"><i class="fas fa-plus"></i></button>
                    <button onclick="resetTasbeeh()" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Reset</button>
                </div>
            </div>
            
            <!-- Naat View -->
            <div id="naat-view" class="hidden">
                <div class="card rounded-2xl p-6 mx-auto text-center">
                    <h2 class="text-2xl font-semibold mb-4">Naat Collection</h2>
                    <div class="video-container mb-4">
                        <div id="youtube-player"></div>
                    </div>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <button onclick="previousVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-backward"></i></button>
                        <button id="tv-play-button" onclick="playVideo()" class="bg-neon font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-play"></i></button>
                        <button id="tv-pause-button" onclick="pauseVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg hidden"><i class="fas fa-pause"></i></button>
                        <button onclick="nextVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-forward"></i></button>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-lg mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg font-semibold text-neon mb-2">Master Notification Control</h3>
                            <button id="settings-notification-toggle" onclick="toggleMasterNotifications()" class="w-full py-2 px-4 rounded-lg transition-colors">Toggle Notifications</button>
                        </div>
                        <hr class="border-gray-600">
                        <div>
                            <h3 class="text-lg font-semibold text-neon mb-2">Manage Inbox</h3>
                             <button onclick="clearInboxHistory()" class="w-full py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 transition-colors">Clear Inbox History</button>
                        </div>
                    </div>
                    <button onclick="saveSettings()" class="mt-6 w-full bg-neon font-bold py-2 px-4 rounded-lg transition">Save Settings</button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Contact us: radioramadhanworld@gmail.com</p>
            <p>Powered by RAMADHAN WORLD PRODUCTION</p>
        </footer>
    </div>

    <audio id="azan-fajr-audio" src="fajr.mp3" preload="auto"></audio>
    <audio id="azan-other-audio" src="other salah.mp3" preload="auto"></audio>
    <audio id="sms-tune-audio" src="data:audio/mpeg;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU9vT19OaWNlIGZlZWwgYmVhdCBvZiB0aGUgbW9kZXJuIHdvcmxkLiBDb250YWN0IG1lIGF0ICtrZDUyNjU2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NkZWZpbml0ZWx5IG5vdCBhIHZpcnVz" preload="auto"></audio>
    <div id="settings-saved-message" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>
    
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- DOM Elements & State ---
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const islamicDateEl = document.getElementById('islamic-date');
        const locationEl = document.getElementById('location');
        const locationPrompt = document.getElementById('location-prompt');
        const nextPrayerNameEl = document.getElementById('next-prayer-name');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const salahPrayerTimeElements = { Fajr: document.querySelector('#salah-fajr span:last-child'), Sunrise: document.querySelector('#salah-sunrise span:last-child'), Dhuhr: document.querySelector('#salah-dhuhr span:last-child'), Asr: document.querySelector('#salah-asr span:last-child'), Maghrib: document.querySelector('#salah-maghrib span:last-child'), Isha: document.querySelector('#salah-isha span:last-child') };
        const views = { home: document.getElementById('home-view'), qibla: document.getElementById('qibla-view'), listenQuran: document.getElementById('listen-quran-view'), salah: document.getElementById('salah-view'), tasbeeh: document.getElementById('tasbeeh-view'), naat: document.getElementById('naat-view'), calendar: document.getElementById('calendar-view'), inbox: document.getElementById('inbox-view'), settings: document.getElementById('settings-view') };
        const qiblaDirectionEl = document.getElementById('qibla-direction');
        const qiblaLine = document.getElementById('qibla-line');
        const quranSurahList = document.getElementById('quran-surah-list');
        const quranLoadingIndicator = document.getElementById('quran-loading-indicator');
        const quranPlayer = document.getElementById('quran-player');
        const quranAudioPlayer = document.getElementById('quran-audio-player');
        const currentSurahName = document.getElementById('current-surah-name');
        const homeRadioAudioPlayer = document.getElementById('home-radio-audio-player');
        const homeRadioLoadingIndicator = document.getElementById('home-radio-loading-indicator');
        const azanFajrAudio = document.getElementById('azan-fajr-audio');
        const azanOtherAudio = document.getElementById('azan-other-audio');
        const smsTuneAudio = document.getElementById('sms-tune-audio');
        const settingsSavedMessage = document.getElementById('settings-saved-message');
        const tvPlayButton = document.getElementById('tv-play-button');
        const tvPauseButton = document.getElementById('tv-pause-button');
        const tasbeehCounterDisplay = document.getElementById('tasbeeh-counter-display');
        const islamicHistoryContent = document.getElementById('islamic-history-content');
        const settingsNotificationToggle = document.getElementById('settings-notification-toggle');
        const inboxList = document.getElementById('inbox-list');
        
        let tasbeehCount = 0;
        let countdownInterval;
        let qiblaAngle = 0;
        let settings = {}; // Settings object simplified
        let notificationsEnabled = true;
        let youtubePlayer;
        let quranChapters = [];
        let quranListLoaded = false;
        let currentSurahIndex = -1;
        let summaryHistoryText = '';
        let fullHistoryText = '';
        let userCoords = null;
        let notificationLog = [];
        let audioUnlocked = false;

        const NOTIFICATION_STATUS_KEY = 'ramadanAppNotificationStatus';
        const NOTIFICATION_LOG_KEY = 'ramadanAppNotificationLog';
        const LAST_HISTORY_NOTIFICATION_KEY = 'ramadanAppLastHistoryNotification';

        const radioStations = [{ name: "Ramadhan World", url: "https://ramadhan786.radioca.st/;" }];
        const islamicEvents = [
            { hijriDate: '01-01', date: "1 Muharram", name: "Islamic New Year", description: "The start of the Islamic lunar calendar." },
            { hijriDate: '10-01', date: "10 Muharram", name: "Day of Ashura", description: "A day of fasting and remembrance." },
            { hijriDate: '12-03', date: "12 Rabi al-Awwal", name: "Mawlid an-Nabi", description: "The birthday of Prophet Muhammad ﷺ." },
            { hijriDate: '27-07', date: "27 Rajab", name: "Isra and Mi'raj", description: "The Prophet's ﷺ miraculous night journey." },
            { hijriDate: '15-08', date: "15 Sha’ban", name: "Laylat al-Bara'at", description: "The night of forgiveness." },
            { hijriDate: '01-09', date: "1 Ramadan", name: "Start of Ramadan", description: "The beginning of the holy month of fasting." },
            { hijriDate: '27-09', date: "27 Ramadan", name: "Laylat al-Qadr", description: "The Night of Power, better than a thousand months." },
            { hijriDate: '01-10', date: "1 Shawwal", name: "Eid al-Fitr", description: "The festival of breaking the fast." },
            { hijriDate: '09-12', date: "9 Dhul Hijjah", name: "Day of Arafah", description: "The pinnacle of the annual Hajj pilgrimage." },
            { hijriDate: '10-12', date: "10 Dhul Hijjah", name: "Eid al-Adha", description: "The festival of sacrifice." }
        ];

        // --- Core Functions ---
        async function initializeApp() {
            document.body.addEventListener('click', unlockAllAudio, { once: true });
            
            loadSettings();
            loadNotificationStatus();
            loadNotificationLog();
            displayNotificationsInInbox();
            loadTasbeehCount();
            
            const dataFetchPromises = [
                getUserLocation(),
                fetchIslamicHistory()
            ];

            await Promise.all(dataFetchPromises);
            hideLoading();
        }

        function unlockAllAudio() {
            if (audioUnlocked) return;
            const allAudio = [azanFajrAudio, azanOtherAudio, smsTuneAudio, quranAudioPlayer, homeRadioAudioPlayer];
            allAudio.forEach(audio => {
                audio.muted = true;
                const playPromise = audio.play();
                if(playPromise !== undefined){
                    playPromise.then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.muted = false;
                    }).catch(() => {});
                }
            });
            audioUnlocked = true;
            console.log("Audio contexts unlocked by user interaction.");
        }
        
        async function fetchIslamicHistory() {
            try {
                const url = "https://en.wikipedia.org/w/api.php?action=parse&page=Islamic_calendar&prop=text&formatversion=2&format=json&origin=*";
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch from Wikipedia');
                const data = await response.json();
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = data.parse.text;
                
                tempDiv.querySelectorAll('.infobox, .thumb, .mw-editsection, .reflist, .toc, table').forEach(el => el.remove());
                
                const paragraphs = Array.from(tempDiv.querySelectorAll('p'));
                const relevantParagraphs = paragraphs.filter(p => p.textContent.trim().length > 100);
                
                fullHistoryText = relevantParagraphs.map(p => p.innerHTML).join('<br><br>');
                summaryHistoryText = relevantParagraphs.length > 0 ? relevantParagraphs[0].textContent.substring(0, 200) + '...' : 'No summary available.';

                islamicHistoryContent.innerHTML = `
                    <p class="font-amiri">${summaryHistoryText}</p>
                    <button onclick="showFullHistory()" class="action-btn">Read More</button>
                `;
                
                const todayStr = new Date().toDateString();
                const lastSentStr = localStorage.getItem(LAST_HISTORY_NOTIFICATION_KEY);
                if (todayStr !== lastSentStr) {
                    sendNotification(`Today in History: ${summaryHistoryText}`, 'history');
                    localStorage.setItem(LAST_HISTORY_NOTIFICATION_KEY, todayStr);
                }

            } catch (error) {
                console.error("Error fetching Islamic history:", error);
                islamicHistoryContent.innerHTML = `<p>Could not load historical context at this time.</p>`;
            }
        }
        
        function showFullHistory() {
            islamicHistoryContent.innerHTML = `
                <p class="font-amiri text-left">${fullHistoryText}</p>
                <button onclick="showLessHistory()" class="action-btn action-btn-small">Read Less</button>
            `;
        }

        function showLessHistory() {
             islamicHistoryContent.innerHTML = `
                <p class="font-amiri">${summaryHistoryText}</p>
                <button onclick="showFullHistory()" class="action-btn">Read More</button>
            `;
        }

        async function populateEventCalendar(hijriYear) {
            const grid = document.getElementById('islamic-calendar-grid');
            const loadingIndicator = document.getElementById('calendar-loading-indicator');
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to midnight to compare dates only
            
            const apiCalls = islamicEvents.map(event => {
                const dateStr = `${event.hijriDate}-${hijriYear}`;
                return fetch(`https://api.aladhan.com/v1/hToG?date=${dateStr}`).then(res => res.json());
            });

            try {
                const results = await Promise.all(apiCalls);
                const eventsHtml = results.map((result, index) => {
                    const event = islamicEvents[index];
                    if (result.code === 200) {
                        const gregDate = result.data.gregorian;
                        const eventDate = new Date(`${gregDate.month.en} ${gregDate.day}, ${gregDate.year}`);
                        
                        // Only show event if its date is today or in the future
                        if (eventDate >= today) {
                            const fullDisplayDate = eventDate.toLocaleDateString('en-US', {
                                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                            });
                            return `
                                <div class="calendar-item">
                                    <div class="calendar-date">${event.date}</div>
                                    <h3 class="calendar-event-name">${event.name}</h3>
                                    <p class="calendar-event-desc">${event.description}</p>
                                    <div class="gregorian-date">
                                        <strong>Expected Gregorian Date (${gregDate.year}):</strong><br>${fullDisplayDate}
                                    </div>
                                </div>
                            `;
                        }
                    }
                    return ''; // Return empty string for past events or errors
                }).join('');

                if (eventsHtml.trim()) {
                    grid.innerHTML = eventsHtml;
                } else {
                    grid.innerHTML = `<p class="text-center text-gray-400 col-span-full">No upcoming major events found for the remainder of this Hijri year.</p>`;
                }
                
                loadingIndicator.style.display = 'none';
            } catch (error) {
                console.error("Failed to fetch calendar dates:", error);
                loadingIndicator.innerHTML = `<p class="text-red-400">Could not load live calendar dates.</p>`;
            }
        }
        
        function calculateQiblaDirection(userLat, userLon) {
            const kaabaLat = 21.4225;
            const kaabaLon = 39.8262;
            const dLon = (kaabaLon - userLon) * (Math.PI / 180);
            const lat1 = userLat * (Math.PI / 180);
            const lat2 = kaabaLat * (Math.PI / 180);
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            return (Math.atan2(y, x) * (180 / Math.PI) + 360) % 360;
        }

        function getUserLocation() {
            return new Promise((resolve) => {
                locationEl.textContent = 'Fetching location...';
                if (navigator.geolocation) {
                     const geoOptions = { timeout: 10000 };
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        locationPrompt.classList.add('hidden');
                        userCoords = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                        qiblaAngle = calculateQiblaDirection(userCoords.latitude, userCoords.longitude);
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userCoords.latitude}&lon=${userCoords.longitude}`);
                            const data = await response.json();
                            const city = data.address.city || data.address.town || 'Unknown';
                            const country = data.address.country || 'Country';
                            locationEl.textContent = `${city}, ${country}`;
                            const prayerTimes = await getPrayerTimes(city, country);
                            if(prayerTimes) updateCountdown(prayerTimes);
                        } catch (error) {
                            const prayerTimes = await getPrayerTimes("Karachi", "Pakistan");
                             if(prayerTimes) updateCountdown(prayerTimes);
                        }
                        resolve();
                    }, async (error) => {
                        let message = "Location access failed. ";
                        if (error.code === 1) {
                            message = "Location access denied. ";
                        } else if (error.code === 2) {
                            message = "Could not detect your location. ";
                            locationPrompt.classList.remove('hidden');
                        } else if (error.code === 3) {
                            message = "Location request timed out. ";
                        }
                        locationEl.textContent = message + "Using default times for Karachi.";
                        const prayerTimes = await getPrayerTimes("Karachi", "Pakistan");
                        if(prayerTimes) updateCountdown(prayerTimes);
                        resolve();
                    }, geoOptions);
                } else {
                     locationEl.textContent = "Geolocation is not supported. Using default times.";
                     getPrayerTimes("Karachi", "Pakistan").then(prayerTimes => { if(prayerTimes) updateCountdown(prayerTimes) });
                    resolve();
                }
            });
        }

         async function getPrayerTimes(city, country) {
            try {
                const date = new Date();
                const dateString = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                const apiUrl = `https://api.aladhan.com/v1/timingsByCity/${dateString}?city=${city}&country=${country}&method=2`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.code === 200) {
                    displayPrayerTimes(data.data);
                    populateEventCalendar(data.data.date.hijri.year);
                    return data.data.timings;
                }
                 return null;
            } catch (error) {
                console.error("Error fetching prayer times:", error);
                 return null;
            }
        }

        function subtractMinutes(timeStr, minutesToSubtract) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const time = new Date();
            time.setHours(hours, minutes, 0, 0);
            time.setMinutes(time.getMinutes() - minutesToSubtract);
            return `${padZero(time.getHours())}:${padZero(time.getMinutes())}`;
        }

        function displayPrayerTimes(data) {
            const { timings, date } = data;
            islamicDateEl.textContent = `${date.hijri.weekday.en}, ${date.hijri.day} ${date.hijri.month.en} ${date.hijri.year}`;
            
            Object.keys(salahPrayerTimeElements).forEach(prayer => {
                if (salahPrayerTimeElements[prayer] && timings[prayer]) {
                    salahPrayerTimeElements[prayer].textContent = formatTime(timings[prayer]);
                }
            });

            const sehriTime = subtractMinutes(timings.Fajr, 10);
            const iftarTime = subtractMinutes(timings.Maghrib, 2);
            document.querySelector('#salah-sehri span:last-child').textContent = formatTime(sehriTime);
            document.querySelector('#salah-iftar span:last-child').textContent = formatTime(iftarTime);
        }
        
        function updateCountdown(timings) {
            if (countdownInterval) clearInterval(countdownInterval);
            let nextPrayerTriggered = false;

            countdownInterval = setInterval(() => {
                const now = new Date();
                const nextPrayer = findNextPrayer(now, timings);
                if (nextPrayer) {
                    if (nextPrayer.name !== nextPrayerNameEl.textContent) {
                        nextPrayerTriggered = false;
                    }
                    nextPrayerNameEl.textContent = nextPrayer.name;
                    const prayerTime = new Date(`${now.toDateString()} ${nextPrayer.time}`);
                    const diff = prayerTime.getTime() - now.getTime();
                    
                    if (diff > 0) {
                        const hours = Math.floor(diff / 3600000);
                        const minutes = Math.floor((diff % 3600000) / 60000);
                        const seconds = Math.floor((diff % 60000) / 1000);
                        countdownTimerEl.textContent = `${padZero(hours)}:${padZero(minutes)}:${padZero(seconds)}`;
                        if (diff <= 1000 && !nextPrayerTriggered) {
                           triggerPrayerNotification(nextPrayer.name);
                           nextPrayerTriggered = true;
                        }
                    } else {
                        getUserLocation();
                    }
                } else {
                    nextPrayerNameEl.textContent = 'Day Complete';
                    countdownTimerEl.textContent = '00:00:00';
                }
            }, 1000);
        }

        function findNextPrayer(now, timings) {
            for (const prayerName of ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha']) {
                if (timings[prayerName]) {
                    const prayerTime = new Date(`${now.toDateString()} ${timings[prayerName]}`);
                    if (prayerTime > now) return { name: prayerName, time: timings[prayerName] };
                }
            }
            return null;
        }

        function showView(viewName) {
            [quranAudioPlayer, homeRadioAudioPlayer].forEach(p => p.pause());
            if (youtubePlayer && typeof youtubePlayer.pauseVideo === 'function') youtubePlayer.pauseVideo();
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-button[onclick="showView('${viewName}')"]`)?.classList.add('active');
            
            if (viewName === 'listenQuran' && !quranListLoaded) {
                populateQuranList();
            }
            if (viewName === 'qibla') startCompass();
            else stopCompass();
        }

        function hideLoading() {
            loadingScreen.classList.add('opacity-0');
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                mainContent.classList.remove('opacity-0');
            }, 500);
        }

        // --- Qibla Compass ---
        function startCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(permissionState => {
                    if (permissionState === 'granted') {
                         window.addEventListener('deviceorientation', handleOrientation);
                    }
                }).catch(console.error);
            } else {
                 window.addEventListener('deviceorientation', handleOrientation);
            }
        }
        function stopCompass() { window.removeEventListener('deviceorientation', handleOrientation); }
        function handleOrientation(event) {
            let alpha = event.webkitCompassHeading || event.alpha;
            if (alpha !== null) {
                qiblaLine.style.transform = `translateX(-50%) rotate(${qiblaAngle - alpha}deg)`;
            }
        }

        async function populateQuranList() {
            if (quranListLoaded) return;
            quranLoadingIndicator.classList.remove('hidden');
            quranSurahList.classList.add('hidden');
            try {
                const response = await fetch('https://api.quran.com/api/v4/chapters');
                quranChapters = (await response.json()).chapters;
                quranSurahList.innerHTML = quranChapters.map((surah, index) => `
                    <div class="quran-surah cursor-pointer p-3 rounded-lg flex justify-between items-center bg-gray-800 hover:bg-gray-700 transition" onclick="playSurah(${surah.id}, '${surah.name_simple}', this, ${index})">
                        <div><p class="font-semibold">${surah.id}. ${surah.name_simple}</p><p class="text-sm text-gray-400">${surah.translated_name.name}</p></div>
                        <div><i class="fas fa-play text-neon"></i></div>
                    </div>`).join('');
                 quranListLoaded = true;
            } catch (error) {
                console.error("Error fetching Surahs:", error);
                quranSurahList.innerHTML = `<p class="text-center text-red-400 col-span-full">Could not load Surahs.</p>`;
            } finally {
                quranLoadingIndicator.classList.add('hidden');
                quranSurahList.classList.remove('hidden');
            }
        }
        
        async function playSurah(surahId, surahName, element, index) {
            try {
                const response = await fetch(`https://api.quran.com/api/v4/chapter_recitations/7/${surahId}`);
                const audioUrl = (await response.json()).audio_file.audio_url;
                quranAudioPlayer.src = audioUrl;
                quranAudioPlayer.play();
                currentSurahName.textContent = surahName;
                quranPlayer.classList.remove('hidden');
                currentSurahIndex = index;
            } catch (error) { console.error("Error fetching Surah audio:", error); }
        }
        
        quranAudioPlayer.onended = () => {
            if (currentSurahIndex !== -1 && currentSurahIndex < quranChapters.length - 1) {
                const nextIndex = currentSurahIndex + 1;
                const nextSurah = quranChapters[nextIndex];
                playSurah(nextSurah.id, nextSurah.name_simple, null, nextIndex);
            }
        };

        function incrementTasbeeh() { tasbeehCounterDisplay.textContent = ++tasbeehCount; saveTasbeehCount(); }
        function resetTasbeeh() { tasbeehCounterDisplay.textContent = tasbeehCount = 0; saveTasbeehCount(); }
        function saveTasbeehCount() { localStorage.setItem('ramadanTasbeeh', tasbeehCount); }
        function loadTasbeehCount() { tasbeehCount = localStorage.getItem('ramadanTasbeeh') || 0; tasbeehCounterDisplay.textContent = tasbeehCount; }

        function playRamadhanWorldRadio() {
            homeRadioLoadingIndicator.classList.remove('hidden');
            homeRadioAudioPlayer.classList.add('hidden');
            homeRadioAudioPlayer.src = radioStations[0].url;
            homeRadioAudioPlayer.play()
                .then(() => {
                    homeRadioLoadingIndicator.classList.add('hidden');
                    homeRadioAudioPlayer.classList.remove('hidden');
                })
                .catch(() => {
                    homeRadioLoadingIndicator.classList.add('hidden');
                    showTemporaryMessage('Could not play radio.', true);
                });
        }
        
        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('youtube-player', {
                height: '480', width: '854',
                playerVars: { 'playsinline': 1, 'listType': 'playlist', 'list': 'PL6b_3Yr67_wFpDJfaZLlMEUP6h5EroJi2', 'controls': 0, 'rel': 0 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }
        function onPlayerStateChange(event) {
            tvPlayButton.classList.toggle('hidden', event.data === YT.PlayerState.PLAYING);
            tvPauseButton.classList.toggle('hidden', event.data !== YT.PlayerState.PLAYING);
        }
        function playVideo() { youtubePlayer.playVideo(); }
        function pauseVideo() { youtubePlayer.pauseVideo(); }
        function nextVideo() { youtubePlayer.nextVideo(); }
        function previousVideo() { youtubePlayer.previousVideo(); }

        // --- Notification & Inbox Controls ---
        function updateSettingsNotificationUI() {
            if (notificationsEnabled) {
                settingsNotificationToggle.textContent = 'Notifications are ON (Click to Disable)';
                settingsNotificationToggle.classList.remove('bg-red-600', 'hover:bg-red-700');
                settingsNotificationToggle.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                settingsNotificationToggle.textContent = 'Notifications are OFF (Click to Enable)';
                settingsNotificationToggle.classList.remove('bg-green-600', 'hover:bg-green-700');
                settingsNotificationToggle.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        function saveNotificationStatus() {
            localStorage.setItem(NOTIFICATION_STATUS_KEY, notificationsEnabled);
        }

        function loadNotificationStatus() {
            const savedStatus = localStorage.getItem(NOTIFICATION_STATUS_KEY);
            notificationsEnabled = savedStatus === null ? true : (savedStatus === 'true');
            updateSettingsNotificationUI();
        }

        function toggleMasterNotifications() {
            if (Notification.permission === 'denied') {
                showTemporaryMessage('Notifications are blocked by your browser.', true);
                return;
            }
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationsEnabled = !notificationsEnabled;
                        saveNotificationStatus();
                        updateSettingsNotificationUI();
                        showTemporaryMessage(`Notifications ${notificationsEnabled ? 'Enabled' : 'Disabled'}`);
                    }
                });
            } else {
                notificationsEnabled = !notificationsEnabled;
                saveNotificationStatus();
                updateSettingsNotificationUI();
                showTemporaryMessage(`Notifications ${notificationsEnabled ? 'Enabled' : 'Disabled'}`);
            }
        }

        function logNotification(message, type) {
            notificationLog.unshift({ message, type, timestamp: new Date().toISOString() });
            pruneNotificationLog();
            localStorage.setItem(NOTIFICATION_LOG_KEY, JSON.stringify(notificationLog));
            displayNotificationsInInbox();
        }

        function loadNotificationLog() {
            notificationLog = JSON.parse(localStorage.getItem(NOTIFICATION_LOG_KEY) || '[]');
            pruneNotificationLog();
        }

        function pruneNotificationLog() {
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            notificationLog = notificationLog.filter(item => new Date(item.timestamp) > twoDaysAgo);
            localStorage.setItem(NOTIFICATION_LOG_KEY, JSON.stringify(notificationLog));
        }
        
        function displayNotificationsInInbox() {
            if (notificationLog.length === 0) {
                inboxList.innerHTML = `<p class="text-center text-gray-400">No notifications in the last 48 hours.</p>`;
                return;
            }
            inboxList.innerHTML = notificationLog.map(item => {
                const itemDate = new Date(item.timestamp);
                const formattedTime = `${itemDate.toLocaleDateString()} at ${itemDate.toLocaleTimeString()}`;
                const typeClass = item.type === 'history' ? 'history' : '';
                return `
                    <div class="inbox-item ${typeClass}">
                        <p>${item.message}</p>
                        <p class="timestamp">${formattedTime}</p>
                    </div>
                `;
            }).join('');
        }

        function clearInboxHistory() {
            notificationLog = [];
            localStorage.removeItem(NOTIFICATION_LOG_KEY);
            displayNotificationsInInbox();
            showTemporaryMessage('Inbox history has been cleared.');
        }

        function sendNotification(message, type) {
             if (!notificationsEnabled) return;
             logNotification(message, type);
             if (Notification.permission === "granted") {
                 new Notification(message);
             }
        }
        
        function triggerPrayerNotification(prayerName) {
            if (!notificationsEnabled) return;

            const message = `It's time for ${prayerName} prayer!`;
            sendNotification(message, 'salah');
            
            // Default behavior is to play the full Azan
            const audioToPlay = prayerName === 'Fajr' ? azanFajrAudio : azanOtherAudio;
            if (audioToPlay) {
                audioToPlay.play().catch(e => showTemporaryMessage('Azan blocked by browser.', true));
            }
        }

        function saveSettings() {
            // Settings are saved implicitly now (e.g., notification toggle)
            localStorage.setItem('ramadanAppSettings', JSON.stringify(settings)); // Save empty settings object for future use
            showTemporaryMessage('Settings Saved!');
        }
        function loadSettings() {
            const savedSettings = localStorage.getItem('ramadanAppSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
        }
        
        function showTemporaryMessage(message, isError = false) {
            settingsSavedMessage.textContent = message;
            settingsSavedMessage.style.backgroundColor = isError ? '#ef4444' : '#10B981';
            settingsSavedMessage.classList.add('opacity-100');
            setTimeout(() => {
                settingsSavedMessage.classList.remove('opacity-100');
            }, 4000);
        }

        function formatTime(time24) {
            const [hour, minute] = time24.split(':');
            const h = parseInt(hour, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${padZero(h12)}:${minute} ${ampm}`;
        }
        function padZero(num) { return num < 10 ? '0' + num : String(num); }

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>