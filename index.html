<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ramadhan World App - Prayer Times, Qibla, Quran</title>
    <meta name="description" content="An all-in-one Islamic app featuring accurate prayer times, Sehri and Iftar times, Qibla compass, Quran recitation, a dynamic Islamic calendar, Naat collection, a Tasbeeh counter, and live streaming.">
    <meta name="keywords" content="islamic app, prayer times, qibla direction, quran online, ramadan 2025, sehri time, iftar time, islamic calendar, hijri date, naat, tasbeeh counter, ramadhan world, islamic history, salah times, listen quran, live stream">

    <!-- iOS & Mobile Web App Specific Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ramadhan World">
    <link rel="apple-touch-icon" href="https://i.ibb.co/Zp0bgjsS/ART-WORKS-1.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .font-amiri {
            font-family: 'Amiri', serif;
        }
        h1, h2, h3, h4 {
            color: white;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        #countdown-timer {
            color: white;
            font-weight: 700; /* Bolder font */
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8), 0 0 20px rgba(50, 230, 0, 0.6); /* Glowing neon effect */
        }
        .prayer-time.active {
            background-color: rgba(50, 230, 0, 0.25);
            border-left-width: 4px;
            border-color: #32e600;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .nav-button.active, .action-btn, .bg-neon {
            background-color: #32e600;
            color: white;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 15px rgba(50, 230, 0, 0.5);
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem;
            max-width: 960px;
            margin: auto;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #compass {
            position: relative;
            width: 256px;
            height: 256px;
            background-color: #1f2937; /* Replaced image with a background color */
            background-size: cover;
            background-position: center;
            border-radius: 9999px;
            border: 4px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem auto;
            transition: transform 0.2s linear;
        }
        #qibla-line {
            position: absolute;
            width: 4px;
            height: 100px;
            background: linear-gradient(to top, #32e600, transparent);
            top: 28px;
            left: calc(50% - 2px);
            transform-origin: bottom center;
            transition: transform 0.2s linear;
            box-shadow: 0 0 15px rgba(50, 230, 0, 0.8);
            z-index: 5;
            border-radius: 2px;
        }
        .section-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 48rem;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .section-title {
            font-family: 'Cairo', sans-serif;
            font-size: 1.875rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #hadith-content p {
            font-size: 1.125rem;
            line-height: 1.75;
            color: #d1d5db;
        }
        #hadith-reference {
            font-size: 1rem;
            color: #9ca3af;
            margin-top: 1rem;
            font-style: italic;
        }
        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #32e600;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
        }
        .calendar-item {
            background-color: rgba(50, 230, 0, 0.1);
            border: 1px solid rgba(50, 230, 0, 0.2);
            border-radius: 0.75rem;
            padding: 1.25rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        .calendar-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
        }
        .calendar-date {
            font-family: 'Amiri', serif;
            font-size: 1.25rem;
            background-color: #32e600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            display: inline-block;
            margin-bottom: 0.75rem;
        }
        .calendar-event-name {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .calendar-event-desc {
            font-size: 1rem;
            color: #d1d5db;
            flex-grow: 1;
        }
        .gregorian-date {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 0.75rem;
        }
        .text-neon { color: #32e600; }
        .border-neon { border-color: #32e600; }
        .hover-bg-neon:hover { background-color: #32e600; color: white; font-weight: 700; text-shadow: 0 0 10px rgba(255,255,255,0.7); box-shadow: 0 0 15px rgba(50, 230, 0, 0.5); }
        
        #quran-player, #home-radio-section .card {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }
        #quran-audio-player::-webkit-media-controls-panel,
        #home-radio-audio-player::-webkit-media-controls-panel {
            background-color: #374151;
        }
        #quran-audio-player::-webkit-media-controls-play-button,
        #quran-audio-player::-webkit-media-controls-current-time-display,
        #quran-audio-player::-webkit-media-controls-time-remaining-display,
        #quran-audio-player::-webkit-media-controls-mute-button,
        #home-radio-audio-player::-webkit-media-controls-play-button,
        #home-radio-audio-player::-webkit-media-controls-current-time-display,
        #home-radio-audio-player::-webkit-media-controls-time-remaining-display,
        #home-radio-audio-player::-webkit-media-controls-mute-button {
            color: #32e600;
            border-radius: 9999px;
        }
        #quran-audio-player::-webkit-media-controls-timeline,
        #home-radio-audio-player::-webkit-media-controls-timeline {
            background-color: rgba(50, 230, 0, 0.2);
            border-radius: 9999px;
            margin: 0 10px;
        }
        #quran-audio-player::-webkit-media-controls-volume-slider,
        #home-radio-audio-player::-webkit-media-controls-volume-slider {
             background-color: rgba(50, 230, 0, 0.2);
            border-radius: 9999px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50 transition-opacity duration-500">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-neon"></div>
        <p class="mt-4 text-lg">Finding your location & fetching data...</p>
        <p id="location-prompt" class="mt-2 text-yellow-400 hidden">Please enable location services and refresh.</p>
    </div>

    <div id="main-content" class="min-h-screen container mx-auto p-4 sm:p-6 lg:p-8 opacity-0 transition-opacity duration-1000">
        <!-- Header Section -->
        <header class="text-center mb-6">
            <img id="app-logo" src="https://i.ibb.co/Zp0bgjsS/ART-WORKS-1.png" alt="Ramadhan World Logo" class="w-[200px] h-[200px] mx-auto mb-4 rounded-full shadow-lg object-contain">
            <h1 class="text-4xl sm:text-5xl">Ramadhan World</h1>
            <p id="islamic-date" class="text-lg text-gray-300 mt-2">Loading Islamic Date...</p>
            <p id="location" class="text-md text-gray-400 mt-1">Fetching location...</p>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center gap-2 mb-6 flex-wrap items-center">
            <button onclick="showView('home')" class="nav-button active px-4 py-2 rounded-lg bg-gray-700 transition">Home</button>
            <button onclick="showView('salah')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Salah</button>
            <button onclick="showView('listenQuran')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Quran</button>
            <button onclick="showView('tasbeeh')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Tasbeeh</button>
            <button onclick="showView('naat')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Naat</button>
            <button onclick="showView('qibla')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Qibla</button>
            <button onclick="showView('calendar')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Calendar</button>
        </nav>

        <!-- Main Views -->
        <main>
            <!-- Home View -->
            <div id="home-view">
                <section id="countdown-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <h2 class="text-2xl mb-2">Time until <span id="next-prayer-name" class="text-neon">...</span></h2>
                        <div id="countdown-timer" class="text-6xl tracking-wider">00:00:00</div>
                    </div>
                </section>

                <section id="home-radio-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <h2 class="text-2xl mb-4">PRESS TO PLAY LIVE RADIO</h2>
                        <audio id="home-radio-audio-player" controls controlslist="nodownload" class="w-full rounded-lg" src="https://ramadhan786.radioca.st/;" crossorigin="anonymous"></audio>
                    </div>
                </section>
                
                <!-- Today's Hadith Section -->
                <section id="hadith-section" class="mb-8">
                    <div class="section-card">
                        <h2 id="hadith-title" class="section-title">📜 Today's Hadith</h2>
                        <div id="hadith-content" class="text-center font-amiri">
                            <p>Loading a daily reminder...</p>
                        </div>
                         <div id="hadith-reference" class="text-center"></div>
                    </div>
                </section>
            </div>
            
            <!-- Calendar View -->
            <div id="calendar-view" class="hidden">
                <section id="islamic-calendar-section">
                     <div class="section-card">
                        <h2 class="section-title">🗓️ Major Islamic Events</h2>
                        <div id="calendar-loading-indicator" class="text-center py-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-neon mx-auto"></div>
                            <p class="mt-4 text-lg">Fetching live dates...</p>
                        </div>
                        <div id="islamic-calendar-grid" class="calendar-grid">
                            <!-- Events will be populated here by JavaScript -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Qibla View -->
            <div id="qibla-view" class="hidden text-center">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto">
                    <h2 class="text-2xl mb-4">Qibla Compass</h2>
                    <div id="compass">
                        <div id="qibla-line"></div>
                    </div>
                    <p id="qibla-direction" class="mt-4 text-lg text-gray-300">For accurate results, hold your device flat, away from any metals.</p>
                    <p id="qibla-error" class="text-sm text-yellow-400 mt-2 hidden">Could not get compass data. Please use a supported device and browser and grant permissions.</p>
                    <p class="text-amber-500 mt-4 font-semibold">This feature is coming soon.</p>
                </div>
            </div>

            <!-- Listen Quran View -->
            <div id="listen-quran-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-4xl mx-auto">
                    <h2 class="text-2xl mb-4 text-center">Holy Quran Recitation</h2>
                    <div id="quran-player" class="text-center hidden">
                        <h3 id="current-surah-name" class="text-xl mb-2 text-neon"></h3>
                        <audio id="quran-audio-player" controls controlslist="nodownload" class="w-full rounded-lg"></audio>
                    </div>
                    <div id="quran-loading-indicator" class="text-center py-8 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-neon mx-auto"></div>
                        <p class="mt-4 text-lg">Loading Surahs...</p>
                    </div>
                    <div id="quran-surah-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Salah View -->
            <div id="salah-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl mb-4 text-center">Today's Times</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div id="salah-fajr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Fajr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-sunrise" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Sunrise</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-dhuhr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Dhuhr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-asr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Asr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-maghrib" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Maghrib</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-isha" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Isha</span><span class="text-xl font-mono">--:--</span></div>
                    </div>
                    <hr class="border-gray-600 my-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div id="salah-sehri" class="card rounded-xl p-4 flex justify-between items-center border-l-4" style="background-color: rgba(50, 230, 0, 0.2); border-color: #32e600;">
                            <span class="font-semibold text-lg">Sehri End</span>
                            <span class="text-xl font-mono">--:--</span>
                        </div>
                        <div id="salah-iftar" class="card rounded-xl p-4 flex justify-between items-center bg-yellow-800 border-l-4 border-yellow-400">
                            <span class="font-semibold text-lg">Iftar</span>
                            <span class="text-xl font-mono">--:--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tasbeeh View -->
            <div id="tasbeeh-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto text-center">
                    <h2 class="text-2xl mb-4">Tasbeeh Counter</h2>
                    <div id="tasbeeh-counter-display" class="font-mono text-7xl font-bold text-neon mb-4">0</div>
                    <button onclick="incrementTasbeeh()" class="w-48 h-48 rounded-full bg-neon text-white text-5xl flex items-center justify-center mx-auto shadow-lg transform transition hover:scale-105 active:scale-95" style="box-shadow: 0 0 20px rgba(50, 230, 0, 0.6);"><i class="fas fa-plus"></i></button>
                    <button onclick="resetTasbeeh()" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Reset</button>
                </div>
            </div>
            
            <!-- Naat View -->
            <div id="naat-view" class="hidden">
                <div class="card rounded-2xl p-6 mx-auto text-center">
                    <h2 class="text-2xl mb-4">Naat Collection</h2>
                    <div class="video-container mb-4">
                        <div id="youtube-player"></div>
                    </div>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <button onclick="previousVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-backward"></i></button>
                        <button id="tv-play-button" onclick="playVideo()" class="bg-neon py-2 px-4 rounded-full text-lg"><i class="fas fa-play"></i></button>
                        <button id="tv-pause-button" onclick="pauseVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg hidden"><i class="fas fa-pause"></i></button>
                        <button onclick="nextVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-forward"></i></button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Contact us: radioramadhanworld@gmail.com</p>
            <p>Powered by RAMADHAN WORLD PRODUCTION</p>
        </footer>
    </div>

    <div id="settings-saved-message" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>
    
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- DOM Elements & State ---
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const islamicDateEl = document.getElementById('islamic-date');
        const locationEl = document.getElementById('location');
        const locationPrompt = document.getElementById('location-prompt');
        const nextPrayerNameEl = document.getElementById('next-prayer-name');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const salahPrayerTimeElements = { Fajr: document.querySelector('#salah-fajr span:last-child'), Sunrise: document.querySelector('#salah-sunrise span:last-child'), Dhuhr: document.querySelector('#salah-dhuhr span:last-child'), Asr: document.querySelector('#salah-asr span:last-child'), Maghrib: document.querySelector('#salah-maghrib span:last-child'), Isha: document.querySelector('#salah-isha span:last-child') };
        const views = { home: document.getElementById('home-view'), qibla: document.getElementById('qibla-view'), listenQuran: document.getElementById('listen-quran-view'), salah: document.getElementById('salah-view'), tasbeeh: document.getElementById('tasbeeh-view'), naat: document.getElementById('naat-view'), calendar: document.getElementById('calendar-view') };
        const qiblaDirectionEl = document.getElementById('qibla-direction');
        const qiblaLine = document.getElementById('qibla-line');
        const qiblaError = document.getElementById('qibla-error');
        const compass = document.getElementById('compass');
        const quranSurahList = document.getElementById('quran-surah-list');
        const quranLoadingIndicator = document.getElementById('quran-loading-indicator');
        const quranPlayer = document.getElementById('quran-player');
        const quranAudioPlayer = document.getElementById('quran-audio-player');
        const homeRadioAudioPlayer = document.getElementById('home-radio-audio-player');
        const currentSurahName = document.getElementById('current-surah-name');
        const settingsSavedMessage = document.getElementById('settings-saved-message');
        const tvPlayButton = document.getElementById('tv-play-button');
        const tvPauseButton = document.getElementById('tv-pause-button');
        const tasbeehCounterDisplay = document.getElementById('tasbeeh-counter-display');
        const hadithContent = document.getElementById('hadith-content');
        const hadithReference = document.getElementById('hadith-reference');
        
        let tasbeehCount = 0;
        let countdownInterval;
        let qiblaAngle = 0;
        let notificationsEnabled = true;
        let youtubePlayer;
        let quranChapters = [];
        let quranListLoaded = false;
        let userCoords = null;
        let audioUnlocked = false;

        let intendedAudioSource = null; // 'quran', 'naat', 'radio' or null
        let currentPlayingQuran = { element: null, surahId: null, index: -1 };
        let isFetchingSurah = false;

        const dailyHadiths = [
            { text: "The Prophet (ﷺ) said, 'The best among you are those who have the best manners and character.'", reference: "Sahih al-Bukhari 3559" },
            { text: "The Prophet (ﷺ) said, 'He who eats his fill while his neighbor goes without food is not a believer.'", reference: "Al-Bayhaqi" },
            { text: "The Prophet (ﷺ) said, 'A man's true wealth is the good he does in this world.'", reference: "Sahih Muslim" },
            { text: "The Prophet (ﷺ) said, 'Seek knowledge from the cradle to the grave.'", reference: "Al-Tirmidhi" },
            { text: "The Prophet (ﷺ) said, 'The strongest among you is the one who controls his anger.'", reference: "Sahih al-Bukhari 6114" },
            { text: "The Prophet (ﷺ) said, 'Richness is not having many possessions, but richness is the richness of the soul.'", reference: "Sahih Muslim 1051" },
            { text: "The Prophet (ﷺ) said, 'Do not wish to be like anyone except in two cases. The first is a person whom Allah has given wealth and he spends it righteously. The second is the one whom Allah has given wisdom and he acts according to it and teaches it to others.'", reference: "Sahih al-Bukhari 73" },
            { text: "The Prophet (ﷺ) said, 'Whoever believes in Allah and the Last Day, let him speak good or else keep silent.'", reference: "Sahih al-Bukhari 6018" }
        ];

        const islamicEvents = [
            { hijriDate: '01-01', date: "1 Muharram", name: "Islamic New Year", description: "The start of the Islamic lunar calendar." },
            { hijriDate: '10-01', date: "10 Muharram", name: "Day of Ashura", description: "A day of fasting and remembrance." },
            { hijriDate: '12-03', date: "12 Rabi al-Awwal", name: "Mawlid an-Nabi", description: "The birthday of Prophet Muhammad ﷺ." },
            { hijriDate: '27-07', date: "27 Rajab", name: "Isra and Mi'raj", description: "The Prophet's ﷺ miraculous night journey." },
            { hijriDate: '15-08', date: "15 Sha’ban", name: "Laylat al-Bara'at", description: "The night of forgiveness." },
            { hijriDate: '01-09', date: "1 Ramadan", name: "Start of Ramadan", description: "The beginning of the holy month of fasting." },
            { hijriDate: '27-09', date: "27 Ramadan", name: "Laylat al-Qadr", description: "The Night of Power, better than a thousand months." },
            { hijriDate: '01-10', date: "1 Shawwal", name: "Eid al-Fitr", description: "The festival of breaking the fast." },
            { hijriDate: '09-12', date: "9 Dhul Hijjah", name: "Day of Arafah", description: "The pinnacle of the annual Hajj pilgrimage." },
            { hijriDate: '10-12', date: "10 Dhul Hijjah", name: "Eid al-Adha", description: "The festival of sacrifice." }
        ];

        function manageAudioPlayback(source) {
            if (source !== 'radio' && homeRadioAudioPlayer && !homeRadioAudioPlayer.paused) { homeRadioAudioPlayer.pause(); }
            if (source !== 'quran' && !quranAudioPlayer.paused) { quranAudioPlayer.pause(); }
            if (source !== 'naat' && youtubePlayer && typeof youtubePlayer.pauseVideo === 'function' && youtubePlayer.getPlayerState() === 1) {
                youtubePlayer.pauseVideo();
            }
            intendedAudioSource = source;

            if(source === 'naat' && youtubePlayer && typeof youtubePlayer.playVideo === 'function') {
                youtubePlayer.playVideo();
            }
        }

        async function initializeApp() {
            document.body.addEventListener('click', unlockAllAudio, { once: true });
            homeRadioAudioPlayer.addEventListener('play', () => manageAudioPlayback('radio'));
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            loadTasbeehCount();
            displayDailyHadith();
            await getUserLocation();
            hideLoading();
        }

        function unlockAllAudio() {
            if (audioUnlocked) return;
            [quranAudioPlayer, homeRadioAudioPlayer].forEach(audio => {
                audio.muted = true;
                const playPromise = audio.play();
                if(playPromise !== undefined){
                    playPromise.then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.muted = false;
                    }).catch(() => {});
                }
            });
            audioUnlocked = true;
        }
        
        function displayDailyHadith() {
            const now = new Date();
            // Changes every 12 hours
            const period = Math.floor(now.getTime() / (1000 * 60 * 60 * 12));
            const hadithIndex = period % dailyHadiths.length;
            const selectedHadith = dailyHadiths[hadithIndex];
            
            hadithContent.innerHTML = `<p>"${selectedHadith.text}"</p>`;
            hadithReference.textContent = `— ${selectedHadith.reference}`;
        }

        async function populateEventCalendar(hijriYear) {
            const grid = document.getElementById('islamic-calendar-grid');
            const loadingIndicator = document.getElementById('calendar-loading-indicator');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let eventsHtml = '';
            
            try {
                for (const [index, event] of islamicEvents.entries()) {
                    let eventDataResult;
                    
                    // Fetch for the current Hijri year
                    const initialResponse = await fetch(`https://api.aladhan.com/v1/hToG?date=${event.hijriDate}-${hijriYear}`);
                    const initialResult = await initialResponse.json();

                    if (initialResult.code === 200) {
                        const gregData = initialResult.data.gregorian;
                        const eventDate = new Date(`${gregData.month.en} ${gregData.day}, ${gregData.year}`);
                        
                        // If the event has passed this year, fetch for next year
                        if (eventDate < today) {
                            const nextYearResponse = await fetch(`https://api.aladhan.com/v1/hToG?date=${event.hijriDate}-${parseInt(hijriYear) + 1}`);
                            eventDataResult = await nextYearResponse.json();
                        } else {
                            eventDataResult = initialResult;
                        }
                    } else {
                         // If initial fetch fails, try for next year as a fallback
                         const nextYearResponse = await fetch(`https://api.aladhan.com/v1/hToG?date=${event.hijriDate}-${parseInt(hijriYear) + 1}`);
                         eventDataResult = await nextYearResponse.json();
                    }

                    if (eventDataResult && eventDataResult.code === 200) {
                        const gregDate = eventDataResult.data.gregorian;
                        const fullDisplayDate = new Date(`${gregDate.month.en} ${gregDate.day}, ${gregDate.year}`).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                        eventsHtml += `<div class="calendar-item">
                                            <div class="calendar-date">${islamicEvents[index].date}</div>
                                            <h3 class="calendar-event-name">${islamicEvents[index].name}</h3>
                                            <p class="calendar-event-desc">${islamicEvents[index].description}</p>
                                            <div class="gregorian-date"><strong>Expected Gregorian Date (${gregDate.year}):</strong><br>${fullDisplayDate}</div>
                                        </div>`;
                    }
                }
                
                grid.innerHTML = eventsHtml.trim() ? eventsHtml : `<p class="text-center text-gray-400 col-span-full">Could not load event dates.</p>`;
                loadingIndicator.style.display = 'none';

            } catch (error) {
                loadingIndicator.innerHTML = `<p class="text-red-400">Could not load live calendar dates.</p>`;
            }
        }
        
        function calculateQiblaDirection(userLat, userLon) {
            const kaabaLat = 21.4225, kaabaLon = 39.8262;
            const dLon = (kaabaLon - userLon) * (Math.PI / 180);
            const lat1 = userLat * (Math.PI / 180), lat2 = kaabaLat * (Math.PI / 180);
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            let angle = (Math.atan2(y, x) * (180 / Math.PI) + 360) % 360;
            qiblaDirectionEl.textContent = `Qibla is at ${angle.toFixed(1)}° from North. Hold device flat.`;
            return angle;
        }

        function getUserLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    locationEl.textContent = "Geolocation is not supported. Using default times.";
                    getPrayerTimes("Karachi", "Pakistan").then(prayerTimes => { if(prayerTimes) updateCountdown(prayerTimes) });
                    return resolve();
                }
                navigator.geolocation.getCurrentPosition(async (position) => {
                    userCoords = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                    qiblaAngle = calculateQiblaDirection(userCoords.latitude, userCoords.longitude);
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userCoords.latitude}&lon=${userCoords.longitude}`);
                        const data = await response.json();
                        const city = data.address.city || data.address.town || 'Unknown', country = data.address.country || 'Country';
                        locationEl.textContent = `${city}, ${country}`;
                        const prayerTimes = await getPrayerTimes(city, country);
                        if(prayerTimes) updateCountdown(prayerTimes);
                    } catch (error) {
                        const prayerTimes = await getPrayerTimes("Karachi", "Pakistan");
                        if(prayerTimes) updateCountdown(prayerTimes);
                    }
                    resolve();
                }, async (error) => {
                    let message = "Location access failed. Using default times for Karachi.";
                    if (error.code === 1) message = "Location access denied. Using default times for Karachi.";
                    else if (error.code === 2) { message = "Could not detect your location. Using default times for Karachi."; locationPrompt.classList.remove('hidden'); }
                    locationEl.textContent = message;
                    const prayerTimes = await getPrayerTimes("Karachi", "Pakistan");
                    if(prayerTimes) updateCountdown(prayerTimes);
                    resolve();
                }, { timeout: 10000 });
            });
        }

        async function getPrayerTimes(city, country) {
            try {
                const date = new Date(), dateString = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                const response = await fetch(`https://api.aladhan.com/v1/timingsByCity/${dateString}?city=${city}&country=${country}&method=2`);
                const data = await response.json();
                if (data.code === 200) {
                    displayPrayerTimes(data.data);
                    populateEventCalendar(data.data.date.hijri.year);
                    return data.data.timings;
                }
                return null;
            } catch (error) { 
                console.error("Error fetching prayer times:", error);
                return null; 
            }
        }

        function subtractMinutes(timeStr, minutes) {
            const [h, m] = timeStr.split(':').map(Number);
            const time = new Date(); time.setHours(h, m - minutes, 0, 0);
            return `${padZero(time.getHours())}:${padZero(time.getMinutes())}`;
        }

        function displayPrayerTimes(data) {
            const { timings, date } = data;
            islamicDateEl.textContent = `${date.hijri.weekday.en}, ${date.hijri.day} ${date.hijri.month.en} ${date.hijri.year}`;
            Object.keys(salahPrayerTimeElements).forEach(p => { if (salahPrayerTimeElements[p] && timings[p]) salahPrayerTimeElements[p].textContent = formatTime(timings[p]); });
            document.querySelector('#salah-sehri span:last-child').textContent = formatTime(subtractMinutes(timings.Fajr, 10));
            document.querySelector('#salah-iftar span:last-child').textContent = formatTime(timings.Maghrib);
        }
        
        function updateCountdown(timings) {
            if (countdownInterval) clearInterval(countdownInterval);
            let nextPrayerTriggered = false;
            countdownInterval = setInterval(() => {
                const now = new Date();
                const nextPrayer = findNextPrayer(now, timings);
                if (nextPrayer) {
                    if (nextPrayer.name !== nextPrayerNameEl.textContent) nextPrayerTriggered = false;
                    nextPrayerNameEl.textContent = nextPrayer.name;
                    const diff = new Date(`${now.toDateString()} ${nextPrayer.time}`).getTime() - now.getTime();
                    if (diff > 0) {
                        const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
                        countdownTimerEl.textContent = `${padZero(h)}:${padZero(m)}:${padZero(s)}`;
                        if (diff <= 1000 && !nextPrayerTriggered) { triggerPrayerNotification(nextPrayer.name); nextPrayerTriggered = true; }
                    } else { getUserLocation(); }
                } else { nextPrayerNameEl.textContent = 'Day Complete'; countdownTimerEl.textContent = '00:00:00'; }
            }, 1000);
        }

        function findNextPrayer(now, timings) {
            for (const prayerName of ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha']) {
                if (timings[prayerName]) {
                    const prayerTime = new Date(`${now.toDateString()} ${timings[prayerName]}`);
                    if (prayerTime > now) return { name: prayerName, time: timings[prayerName] };
                }
            }
            return null;
        }

        function showView(viewName) {
            // If Quran or Naat is playing, stop it when changing views.
            // The radio is allowed to continue playing.
            if(intendedAudioSource === 'quran' || intendedAudioSource === 'naat') {
                manageAudioPlayback(null);
            }

            Object.values(views).forEach(v => v.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-button[onclick="showView('${viewName}')"]`)?.classList.add('active');
            if (viewName === 'listenQuran' && !quranListLoaded) populateQuranList();
            if (viewName === 'qibla') startCompass(); else stopCompass();
        }

        function hideLoading() {
            loadingScreen.classList.add('opacity-0');
            setTimeout(() => { loadingScreen.style.display = 'none'; mainContent.classList.remove('opacity-0'); }, 500);
        }

        function startCompass() {
            qiblaError.classList.add('hidden');
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(p => { 
                    if (p === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation, true);
                    } else {
                        qiblaError.classList.remove('hidden');
                        qiblaError.textContent = 'Permission denied. Please enable motion sensor access in your browser settings.';
                    }
                }).catch(e => {
                     qiblaError.classList.remove('hidden');
                     qiblaError.textContent = 'Compass feature is not supported or was blocked on this device.';
                });
            } else if ('DeviceOrientationEvent' in window) {
                 window.addEventListener('deviceorientation', handleOrientation, true);
            } else {
                qiblaError.classList.remove('hidden');
                qiblaError.textContent = 'Compass feature is not supported on this device.';
            }
        }
        function stopCompass() { window.removeEventListener('deviceorientation', handleOrientation, true); }
        function handleOrientation(event) {
            let alpha = event.webkitCompassHeading || event.alpha;
            if (alpha === null) {
                qiblaError.classList.remove('hidden');
                qiblaError.textContent = 'Could not get compass data. Please ensure your device has a magnetometer.';
                return;
            }
            compass.style.transform = `rotate(${-alpha}deg)`;
            qiblaLine.style.transform = `rotate(${qiblaAngle}deg)`;
        }

        async function populateQuranList() {
            if (quranListLoaded) return;
            quranLoadingIndicator.classList.remove('hidden');
            try {
                const response = await fetch('https://api.quran.com/api/v4/chapters');
                quranChapters = (await response.json()).chapters;
                quranSurahList.innerHTML = quranChapters.map((s, i) => `
                    <div id="surah-item-${s.id}" class="quran-surah cursor-pointer p-3 rounded-lg flex justify-between items-center bg-gray-800 hover:bg-gray-700 transition" onclick="playSurah(${s.id}, '${s.name_simple}', this, ${i})">
                        <div>
                            <p class="font-semibold">${s.id}. ${s.name_simple}</p>
                            <p class="text-sm text-gray-400">${s.translated_name.name}</p>
                        </div>
                        <div>
                            <i class="fas fa-play text-neon play-icon"></i>
                            <i class="fas fa-pause text-neon pause-icon hidden"></i>
                        </div>
                    </div>`).join('');
                quranListLoaded = true;
            } catch (e) { 
                quranSurahList.innerHTML = `<p class="text-center text-red-400 col-span-full">Could not load Surahs.</p>`; 
            } finally { 
                quranLoadingIndicator.classList.add('hidden'); 
            }
        }
        
        function resetQuranItemUI(element) {
            if (element) {
                const playIcon = element.querySelector('.play-icon');
                const pauseIcon = element.querySelector('.pause-icon');
                if (playIcon && pauseIcon) {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                }
            }
        }

        async function playSurah(surahId, surahName, element, index) {
            if (isFetchingSurah) { return; }

            if (currentPlayingQuran.surahId === surahId) {
                if (quranAudioPlayer.paused) { quranAudioPlayer.play(); } else { quranAudioPlayer.pause(); }
                return;
            }

            isFetchingSurah = true;
            if (currentPlayingQuran.element) { resetQuranItemUI(currentPlayingQuran.element); }
            manageAudioPlayback('quran');
            currentSurahName.textContent = `Loading ${surahName}...`;
            quranPlayer.classList.remove('hidden');

            try {
                const response = await fetch(`https://api.quran.com/api/v4/chapter_recitations/7/${surahId}`);
                if (!response.ok) throw new Error(`API request failed for ${surahName}`);

                const data = await response.json();
                if (!data.audio_file || !data.audio_file.audio_url) { throw new Error(`Audio for ${surahName} is not available.`); }
                
                quranAudioPlayer.src = data.audio_file.audio_url;
                quranAudioPlayer.muted = false; // Ensure not muted
                quranAudioPlayer.volume = 1.0;  // Ensure full volume
                await quranAudioPlayer.play();
                currentSurahName.textContent = surahName;
                currentPlayingQuran = { element, surahId, index };
            } catch (error) {
                currentSurahName.textContent = error.message; 
                resetQuranItemUI(element);
                currentPlayingQuran = { element: null, surahId: null, index: -1 };
            } finally {
                isFetchingSurah = false; 
            }
        }

        quranAudioPlayer.addEventListener('play', () => {
            intendedAudioSource = 'quran';
            manageAudioPlayback('quran');
            if (currentPlayingQuran.element) {
                currentPlayingQuran.element.querySelector('.play-icon').classList.add('hidden');
                currentPlayingQuran.element.querySelector('.pause-icon').classList.remove('hidden');
            }
        });

        quranAudioPlayer.addEventListener('pause', () => { 
            if (currentPlayingQuran.element) { resetQuranItemUI(currentPlayingQuran.element); }
        });
        
        quranAudioPlayer.onended = () => {
            if (currentPlayingQuran.element) { resetQuranItemUI(currentPlayingQuran.element); }
            const nextIndex = currentPlayingQuran.index + 1;
            if (nextIndex < quranChapters.length) {
                const nextSurah = quranChapters[nextIndex];
                const nextElement = document.getElementById(`surah-item-${nextSurah.id}`);
                playSurah(nextSurah.id, nextSurah.name_simple, nextElement, nextIndex);
            } else {
                currentPlayingQuran = { element: null, surahId: null, index: -1 };
                currentSurahName.textContent = "Finished Recitation";
            }
        };

        function incrementTasbeeh() { tasbeehCounterDisplay.textContent = ++tasbeehCount; saveTasbeehCount(); }
        function resetTasbeeh() { tasbeehCounterDisplay.textContent = tasbeehCount = 0; saveTasbeehCount(); }
        function saveTasbeehCount() { localStorage.setItem('ramadanTasbeeh', tasbeehCount); }
        function loadTasbeehCount() { tasbeehCount = localStorage.getItem('ramadanTasbeeh') || 0; tasbeehCounterDisplay.textContent = tasbeehCount; }

        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('youtube-player', { height: '480', width: '854', playerVars: { 'playsinline': 1, 'listType': 'playlist', 'list': 'PL6b_3Yr67_wFpDJfaZLlMEUP6h5EroJi2', 'controls': 1, 'rel': 0 }, events: { 'onStateChange': onPlayerStateChange } });
        }
        
        function onPlayerStateChange(event) {
            tvPlayButton.classList.toggle('hidden', event.data === YT.PlayerState.PLAYING);
            tvPauseButton.classList.toggle('hidden', event.data !== YT.PlayerState.PLAYING);
            if(event.data === YT.PlayerState.PLAYING) {
                manageAudioPlayback('naat');
            }
        }
        
        function playVideo() { manageAudioPlayback('naat'); }
        function pauseVideo() { youtubePlayer.pauseVideo(); intendedAudioSource = null; }
        function nextVideo() { youtubePlayer.nextVideo(); }
        function previousVideo() { youtubePlayer.previousVideo(); }

        function sendNotification(message, type) {
             if (!notificationsEnabled) return;
             if (Notification.permission === "granted") new Notification('Ramadhan World', { body: message, icon: 'https://i.ibb.co/Zp0bgjsS/ART-WORKS-1.png' });
        }
        
        function triggerPrayerNotification(prayerName) {
            if (!notificationsEnabled || prayerName === 'Sunrise') return;
            sendNotification(`It's time for ${prayerName} prayer!`, 'salah');
        }
        
        function showTemporaryMessage(message, isError = false) {
            settingsSavedMessage.textContent = message;
            settingsSavedMessage.style.backgroundColor = isError ? '#ef4444' : '#10B981';
            settingsSavedMessage.classList.add('opacity-100');
            setTimeout(() => settingsSavedMessage.classList.remove('opacity-100'), 4000);
        }

        function formatTime(time24) {
            const [h, m] = time24.split(':');
            const hour = parseInt(h, 10);
            return `${padZero(hour % 12 || 12)}:${m} ${hour >= 12 ? 'PM' : 'AM'}`;
        }
        function padZero(num) { return num < 10 ? '0' + num : String(num); }

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>